services:
  redis:
    image: redis:alpine
    ports: ["6379:6379"]

  rabbitmq:
    image: rabbitmq:3-management
    ports: ["5672:5672", "15672:15672"]
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    # Healthcheck ensures RabbitMQ is actually ready to accept connections
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-service:
    build: ./auth-service
    env_file: [./auth-service/.env]
    extra_hosts: ["host.docker.internal:host-gateway"]

  event-service:
    build: ./event-service
    env_file: [./event-service/.env]
    extra_hosts: ["host.docker.internal:host-gateway"]

  order-service:
    build: ./order-service
    env_file: [./order-service/.env]
    extra_hosts: ["host.docker.internal:host-gateway"]
    depends_on:
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy # Waits for RabbitMQ healthcheck

  payment-service:
    build: ./payment-service
    env_file: [./payment-service/.env]
    extra_hosts: ["host.docker.internal:host-gateway"]
    depends_on:
      rabbitmq:
        condition: service_healthy # Waits for RabbitMQ healthcheck

  gateway:
    build: ./gateway
    env_file: [./gateway/.env]
    ports: ["3000:3000"]
    depends_on:
      [auth-service, order-service, payment-service, event-service, redis]
